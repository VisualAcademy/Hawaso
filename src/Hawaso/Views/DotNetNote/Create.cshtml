@using Hawaso.Models.Notes
@model Note

<div class="container">
    <h2 style="text-align:center;">게시판</h2>
    @ViewBag.TitleDescription
    <hr />

    <div class="row">
        <div class="col-md-offset-2 col-md-8 col-md-offset-2">
            <form asp-controller="DotNetNote" asp-action="Create"
                  enctype="multipart/form-data" method="post" id="boardCreateForm">
                @await Html.PartialAsync("_BoardEditorForm")
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- 자동 저장 경고 모달 -->
    <div class="modal fade" id="autosaveReminderModal" tabindex="-1" role="dialog" aria-labelledby="autosaveReminderLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title" id="autosaveReminderLabel">미저장 변경 사항</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    7분 이상 저장하지 않았습니다. 지금 저장하시겠습니까?
                    <br />
                    <small class="text-muted">
                        아무 행동도 하지 않으면 10분 후 자동으로 저장됩니다.
                    </small>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" id="btnRemindLater" data-dismiss="modal">나중에</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnReminderSaveNow">지금 저장</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            var FORM_ID  = 'boardCreateForm';
            var FORM_SEL = '#' + FORM_ID;

            var CHECK_INTERVAL_MS   = 5000;              // 5초마다 주기적으로 검사
            var WARN_AFTER_MS       = 7 * 60 * 1000;     // 7분 경과 시 경고 모달 표시
            var AUTO_SAVE_AFTER_MS  = 10 * 60 * 1000;    // 10분 경과 시 자동 저장

            var isDirty       = false;   // 미저장 변경이 있는지 여부
            var lastChangedAt = 0;       // 마지막으로 변경이 발생한 시각
            var modalShown    = false;   // 경고 모달이 현재 표시 중인지 여부

            // 새로 추가: 실제 제출 진행 여부(중복 제출 방지용)
            var isSubmitting  = false;

            // 폼 내부 입력이 변경되면 미저장 상태로 플래그 설정 + 시각 기록
            $(document).on('input change', FORM_SEL + ' :input', function () {
                isDirty       = true;
                lastChangedAt = Date.now();
            });

            // 공통: 제출 버튼, 텍스트 상태 관리
            function setSubmitButtonState(disabled, text) {
                var $form   = $(FORM_SEL);
                var $submit = $form.find(':input[type=submit]').first();

                if ($submit.length === 0) {
                    return;
                }

                // 원래 텍스트 저장 (한 번만)
                if (!$submit.data('original-text')) {
                    var orig = ($submit.val() || $submit.text() || '').trim();
                    $submit.data('original-text', orig || '저장');
                }

                // disabled 상태 설정
                $submit.prop('disabled', !!disabled);

                // 텍스트 설정
                if (text) {
                    if ($submit.is('input[type=submit]')) {
                        $submit.val(text);
                    } else {
                        $submit.text(text);
                    }
                } else {
                    // 원래 텍스트 복원
                    var originalText = $submit.data('original-text');
                    if ($submit.is('input[type=submit]')) {
                        $submit.val(originalText);
                    } else {
                        $submit.text(originalText);
                    }
                }
            }

            // 실제 폼 제출 함수 (자동저장 + 수동저장 모두 여기로)
            function submitFormNow() {
                if (isSubmitting) {
                    return; // 중복 제출 방지
                }

                var form = document.getElementById(FORM_ID);
                if (!form) {
                    return;
                }

                isSubmitting = true;

                // 버튼 상태: 비활성화 + "Saving..."
                setSubmitButtonState(true, 'Saving...');

                $('#autosaveReminderModal').modal('hide');

                // jQuery validate가 실패했을 때 버튼을 다시 살려주기 위한 훅
                // (invalid-form.validate 이벤트는 유효성 실패 시 발생)
                $(form).one('invalid-form.validate', function () {
                    isSubmitting = false;
                    setSubmitButtonState(false, null); // 원래 텍스트 복원
                });

                // 브라우저 표준 제출 (검증 포함)
                if (typeof form.requestSubmit === 'function') {
                    form.requestSubmit();
                    return;
                }

                // 최후 폴백: form.submit() (브라우저 검증은 건너뛸 수 있음)
                form.submit();
            }

            // "지금 저장" 버튼 클릭 시 즉시 제출
            $('#btnReminderSaveNow').off('click').on('click', submitFormNow);

            // "나중에" 버튼 클릭 시 → 타이머 재시작
            $('#btnRemindLater').off('click').on('click', function () {
                modalShown    = false;
                lastChangedAt = Date.now();   // 이 시점을 기준으로 7/10분 다시 계산
            });

            // 폼이 정상 제출되면 상태 초기화
            $(FORM_SEL).on('submit', function () {
                isDirty       = false;
                lastChangedAt = 0;
                modalShown    = false;
                // 서버로 넘어가는 시점이라 isSubmitting은 그대로 두어도 무방
            });

            // 수동 "저장" 버튼 클릭도 모두 submitFormNow()로 통일
            $(FORM_SEL)
                .find(':input[type=submit]')
                .off('click.boardSubmit')
                .on('click.boardSubmit', function (e) {
                    e.preventDefault(); // 기본 submit 막고
                    submitFormNow();    // 공통 로직으로 진행
                });

            // 주기적으로 자동 저장 및 경고 조건 검사
            setInterval(function () {
                if (!isDirty) return;        // 변경 사항이 없으면 검사 생략
                if (!lastChangedAt) return;  // 기준 시각이 없으면 검사 생략
                if (isSubmitting) return;    // 이미 제출 중이면 동작 안 함

                var now         = Date.now();
                var sinceChange = now - lastChangedAt;

                // 10분 이상 경과 → 무조건 자동 저장
                if (sinceChange >= AUTO_SAVE_AFTER_MS) {
                    submitFormNow();
                    return;
                }

                // 7분 이상 경과 & 아직 모달을 띄우지 않았다면 → 경고 모달
                if (sinceChange >= WARN_AFTER_MS && !modalShown) {
                    modalShown = true;
                    $('#autosaveReminderModal').modal('show')
                        .on('hidden.bs.modal', function () {
                            modalShown = false;
                        });
                }
            }, CHECK_INTERVAL_MS);
        })();
    </script>
}
