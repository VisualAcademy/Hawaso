@using Hawaso.Models.Notes
@model Note

<div class="container">
    <h2 style="text-align:center;">게시판</h2>
    @ViewBag.TitleDescription
    <hr />

    <div class="row">
        <div class="col-md-offset-2 col-md-8 col-md-offset-2">
            <form asp-controller="DotNetNote" asp-action="Create"
                  enctype="multipart/form-data" method="post" id="boardCreateForm">
                @await Html.PartialAsync("_BoardEditorForm")
            </form>
        </div>
    </div>

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- Auto-save reminder modal -->
    <div class="modal fade" id="autosaveReminderModal" tabindex="-1" role="dialog" aria-labelledby="autosaveReminderLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title" id="autosaveReminderLabel">Unsaved changes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    You haven't saved for over 1 minute. Save now?
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" id="btnRemindLater" data-dismiss="modal">Later</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnReminderSaveNow">Save now</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var FORM_ID = 'boardCreateForm';
            var FORM_SEL = '#' + FORM_ID;

            var CHECK_INTERVAL_MS = 5000;     // 5초마다 체크
            var REMIND_EVERY_MS  = 60000;     // 1분마다 리마인드
            var isDirty = false;              // 미저장 변경 여부
            var lastSavedAt = Date.now();     // 마지막 저장 시각
            var lastPromptAt = 0;             // 마지막 경고 시각
            var modalShown = false;

            // 폼 내부 입력 변경 시 미저장 표시
            $(document).on('input change', FORM_SEL + ' :input', function () {
                // 파일 입력 등도 포함
                isDirty = true;
            });

            // 폼 제출(저장) 시 상태 리셋
            $(FORM_SEL).on('submit', function () {
                isDirty = false;
                lastSavedAt = Date.now();
                lastPromptAt = 0;
                modalShown = false;
                $('#autosaveReminderModal').modal('hide');
            });

            // Save now → 표준 제출(검증 포함)
            function submitNow() {
                var form = document.getElementById(FORM_ID);
                if (!form) return;

                $('#autosaveReminderModal').modal('hide');

                if (typeof form.requestSubmit === 'function') {
                    form.requestSubmit();      // ✅ 브라우저 검증 + submit 이벤트
                    return;
                }
                // 폴백: 활성 submit 버튼 클릭
                var btn = form.querySelector('button[type=submit]:not([disabled]),input[type=submit]:not([disabled])');
                if (btn) { btn.click(); return; }

                // 최후 폴백: 직접 제출(검증 생략)
                form.submit();
            }

            // 버튼 바인딩
            $('#btnReminderSaveNow').off('click').on('click', submitNow);
            $('#btnRemindLater').off('click').on('click', function () {
                lastPromptAt = Date.now();
                modalShown = false;
            });

            // 페이지 비가시 상태(백그라운드 탭)일 땐 알림 생략
            function isPageVisible() { return document.visibilityState === 'visible'; }

            // 1분 경과 시 모달 표시
            setInterval(function () {
                if (!isDirty) return;
                if (!isPageVisible()) return;

                var now = Date.now();
                var sinceSave = now - lastSavedAt;
                var sincePrompt = now - lastPromptAt;

                if (sinceSave >= REMIND_EVERY_MS && sincePrompt >= REMIND_EVERY_MS && !modalShown) {
                    modalShown = true;
                    lastPromptAt = now;
                    $('#autosaveReminderModal').modal('show')
                        .on('hidden.bs.modal', function(){ modalShown = false; });
                }
            }, CHECK_INTERVAL_MS);
        })();
    </script>
}
